trigger:
  branches:
    include:
      - main

variables:
  azureSubscription: 'AzureServiceConnection'   # ← replace with your service connection name
  resourceGroup: 'rg-newsrag'
  acrName: 'newsragacr'
  imageTag: '$(Build.BuildId)'

stages:
  # ───────────────────── Build & Push ─────────────────────
  - stage: Build
    displayName: Build & push container images
    jobs:
      - job: BuildImages
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: AzureCLI@2
            displayName: ACR login
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az acr login --name $(acrName)

          - task: Docker@2
            displayName: Build MCP Server image
            inputs:
              command: buildAndPush
              containerRegistry: $(acrName)
              repository: newsrag-mcp-server
              dockerfile: Dockerfile.mcp-server
              tags: |
                $(imageTag)
                latest

          - task: Docker@2
            displayName: Build Client image
            inputs:
              command: buildAndPush
              containerRegistry: $(acrName)
              repository: newsrag-client
              dockerfile: Dockerfile.client
              tags: |
                $(imageTag)
                latest

  # ───────────────────── Deploy Infra & Apps ─────────────────────
  - stage: Deploy
    displayName: Deploy to Azure Container Apps
    dependsOn: Build
    jobs:
      - job: DeployBicep
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: AzureCLI@2
            displayName: Deploy Bicep template
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az deployment group create \
                  --resource-group $(resourceGroup) \
                  --template-file infra/main.bicep \
                  --parameters \
                    appName=newsrag \
                    imageTag=$(imageTag) \
                    sqlPassword='$(SQL_PASSWORD)' \
                    serperApiKey='$(SERPER_API_KEY)' \
                    azureOpenaiApiKey='$(AZURE_OPENAI_API_KEY)' \
                    azureOpenaiEndpoint='$(AZURE_OPENAI_ENDPOINT)' \
                    azureOpenaiApiVersion='$(AZURE_OPENAI_API_VERSION)' \
                    azureOpenaiDeployment='$(AZURE_OPENAI_DEPLOYMENT)'
